<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Adding new devices - Docs</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../../status.html">Status</a></li><li class="chapter-item expanded "><a href="../../functional_requirements.html"><strong aria-hidden="true">1.</strong> Functional Requirements</a></li><li class="chapter-item expanded "><a href="../../modularization.html"><strong aria-hidden="true">2.</strong> Modularization</a></li><li class="chapter-item expanded "><a href="../../performance_goals.html"><strong aria-hidden="true">3.</strong> Performance Goals</a></li><li class="chapter-item expanded "><a href="../../threat_model.html"><strong aria-hidden="true">4.</strong> Threat Model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../threat_model/methodology.html"><strong aria-hidden="true">4.1.</strong> Methodology</a></li><li class="chapter-item expanded "><a href="../../threat_model/security_assumptions.html"><strong aria-hidden="true">4.2.</strong> Security Assumptions</a></li><li class="chapter-item expanded "><a href="../../threat_model/application_assets.html"><strong aria-hidden="true">4.3.</strong> Application Assets</a></li><li class="chapter-item expanded "><a href="../../threat_model/security_requirements.html"><strong aria-hidden="true">4.4.</strong> Security Requirements</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../threat_model/security_requirements/operators.html"><strong aria-hidden="true">4.4.1.</strong> Operators</a></li><li class="chapter-item expanded "><a href="../../threat_model/security_requirements/public.html"><strong aria-hidden="true">4.4.2.</strong> Public</a></li><li class="chapter-item expanded "><a href="../../threat_model/security_requirements/users.html"><strong aria-hidden="true">4.4.3.</strong> Users</a></li><li class="chapter-item expanded "><a href="../../threat_model/security_requirements/clients.html"><strong aria-hidden="true">4.4.4.</strong> Clients</a></li><li class="chapter-item expanded "><a href="../../threat_model/security_requirements/federated_homeservers.html"><strong aria-hidden="true">4.4.5.</strong> Federated Homeservers</a></li><li class="chapter-item expanded "><a href="../../threat_model/security_requirements/federated_users.html"><strong aria-hidden="true">4.4.6.</strong> Federated Users</a></li><li class="chapter-item expanded "><a href="../../threat_model/security_requirements/federated_clients.html"><strong aria-hidden="true">4.4.7.</strong> Federated Clients</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../cryptographic_primitives.html"><strong aria-hidden="true">5.</strong> Cryptographic Primitives and Schemes</a></li><li class="chapter-item expanded "><a href="../../spec.html"><strong aria-hidden="true">6.</strong> Specification (Draft)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../spec/authentication_service.html"><strong aria-hidden="true">6.1.</strong> Work in progress: Authentication service</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../spec/authentication_service/credentials.html"><strong aria-hidden="true">6.1.1.</strong> Credentials</a></li><li class="chapter-item expanded "><a href="../../spec/authentication_service/evolving_identities.html"><strong aria-hidden="true">6.1.2.</strong> Evolving Identities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../spec/authentication_service/new_device_flow.html" class="active"><strong aria-hidden="true">6.1.2.1.</strong> Adding new devices</a></li></ol></li><li class="chapter-item expanded "><a href="../../spec/authentication_service/connection_establishment.html"><strong aria-hidden="true">6.1.3.</strong> Discovery and connection esablishment</a></li></ol></li><li class="chapter-item expanded "><a href="../../spec/delivery_service.html"><strong aria-hidden="true">6.2.</strong> Delivery service</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../spec/delivery_service/group_state_encryption.html"><strong aria-hidden="true">6.2.1.</strong> Group state encryption</a></li><li class="chapter-item expanded "><a href="../../spec/delivery_service/broken_state_detection.html"><strong aria-hidden="true">6.2.2.</strong> Broken state detection</a></li></ol></li><li class="chapter-item expanded "><a href="../../spec/queuing_service.html"><strong aria-hidden="true">6.3.</strong> Queuing service</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../spec/queuing_service/queue_encryption.html"><strong aria-hidden="true">6.3.1.</strong> Queue encryption</a></li><li class="chapter-item expanded "><a href="../../spec/queuing_service/keypackage_publication.html"><strong aria-hidden="true">6.3.2.</strong> KeyPackage publication</a></li></ol></li><li class="chapter-item expanded "><a href="../../spec/clients.html"><strong aria-hidden="true">6.4.</strong> Work in progress: Clients</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../spec/clients/client_sync.html"><strong aria-hidden="true">6.4.1.</strong> Client synchronization</a></li></ol></li><li class="chapter-item expanded "><a href="../../spec/future_work.html"><strong aria-hidden="true">6.5.</strong> Future work</a></li><li class="chapter-item expanded "><a href="../../spec/glossary.html"><strong aria-hidden="true">6.6.</strong> Glossary</a></li></ol></li><li class="chapter-item expanded "><a href="../../authentication_systems.html"><strong aria-hidden="true">7.</strong> Authentication in messaging applications</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Docs</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="future-workwork-in-progress-registering-a-new-device-when-using-evolving-identity"><a class="header" href="#future-workwork-in-progress-registering-a-new-device-when-using-evolving-identity">Future work/Work in progress: Registering a new device when using Evolving Identity</a></h1>
<p>To register a new client, the user needs to be in possession of one of his existing clients. To properly perform the <a href="evolving_identities.html">evolving identity</a> (EID) operation and securely transfer data from the existing client to the new client, this chapter defines a protocol between new client, the owning user's homeserver and an existing client. The protocol proceeds roughly in the following steps:</p>
<ul>
<li>Establish a channel between new client and old client via the homeserver's rendez-vous service (defined below)</li>
<li>Secure the channel with mutual authentication with the help of the user and a Password-authenticated Key Exchange (PAKE)</li>
<li>Use the secure channel to exchange the information required to add the new client to the user's EID</li>
<li>Add the new client to the user's EID</li>
<li>Transfer user-specific secrets from existing client to new client via the secure channel</li>
<li>Perform the remaining set-up of the new client using the user-specific secrets (QS client record creation at QS, KeyPackage publiction, etc)</li>
</ul>
<h2 id="rendez-vous-service"><a class="header" href="#rendez-vous-service">Rendez-vous service</a></h2>
<p>The existing client and the new client need to communicate in multiple round trips to complete the registration of the new client. The user's homeserver facilitates this by providing a rendez-vous service (RS), which acts as a network proxy between existing and new client.</p>
<p>The RS allows a new client to request a rendez-vous code (RC), which consists of a 16bit randomly generated byte-string.</p>
<p>The new client then establishes a connection to the RS and waits for the new client to also establish a connection using the same RC.</p>
<p>For the new client to establish a connection, the new client displays the RC for the user to manually enter on the new existing (along with the password for the subsequent PAKE, see below).</p>
<p>Once both clients have established a connection, the RS acts as a proxy, forwarding incoming messages from one client to the other.</p>
<p>Due to UX constraints, the new client is expected to initiate the process, which means that the RS has to provide a public (unauthenticated) interface to facilitate the first step. As a result, this interface should be subject to strict (traditional) rate-limiting measures.</p>
<p>The existing client is already registered with the homeserver can be expected to present an <a href="../general_concepts/anonymous_tokens.html">anonymous token</a> when it's connecting to the RS, thus enabling at least partial rate-limiting.</p>
<h2 id="mutual-authentication-between-new-and-existing-client"><a class="header" href="#mutual-authentication-between-new-and-existing-client">Mutual authentication between new and existing client</a></h2>
<p>Once the network channel is established via the RS, the two clients perform an <a href="https://www.ietf.org/id/draft-irtf-cfrg-spake2-26.html">SPAKE2</a> handshake to agree on a key, which they subsequently use to encrypt all messages sent over the RS channel.</p>
<p>SPAKE2 requires that the two clients share a password. The password is randomly generated by the new client and displayed to the user such that it can enter it (along with the similarly displayed RC) into the existing client.</p>
<p>The SPAKE2 PAKE consists of two phases. In each phase, both clients send one message to the other client. After generating the password, the new client can complete phase 1 and send its message to the existing client. Once the password (and RC) was entered into the existing client, it can also send its message for phase 1 and retrieve the message from the new client.</p>
<p>Both clients use the other client's message to complete phase 1 and exchange the messages of phase 2 via the RS.</p>
<p>After completing both phases, the clients have agreed on a symmetric key, which they can use to encrypt further messages using an AEAD algorithm.</p>
<h2 id="adding-the-new-client-to-the-users-eid"><a class="header" href="#adding-the-new-client-to-the-users-eid">Adding the new client to the user's EID</a></h2>
<p>The new client now creates a <a href="../authentication_service/credentials.html#client-credential-signing-requests">Client Credential Signing Request</a> and sends it to the existing client. The existing client in turn signs it with its own client credential private key and submits it to the AS for signing. The existing client then forwards the AS' response to the new client.</p>
<p>With its signed Client Credential, the new client can now create a KeyPackage (which includes the Client Credential) for the EID and send it to the existing client. The existing client subsequently uses the KeyPackage to create the commit adding the new client to the EID and submits it to the AS. The existing client then sends the resulting Welcome, as well as the following user-specific secrets to the new client.</p>
<ul>
<li>user base secret</li>
<li>QS user auth key</li>
<li>friendship secret</li>
</ul>
<p>The existing client also sends group joining bundles for all of the user's groups. The group joining bundle allows the new client to perform an external commit in all groups that the user is a part of. It contains the following group-specific data:</p>
<ul>
<li>
<p>Group ID</p>
</li>
<li>
<p>Group state EAR base secret</p>
</li>
<li>
<p>Credential encryption base secret</p>
</li>
<li>
<p>The new client contacts the AS and asks for a rendez-vous code.</p>
</li>
<li>
<p>The AS responds with a 16bit rendez-vous code.</p>
<ul>
<li>It might be more than 16bit if the 16bit space was exhausted by an adversary.</li>
</ul>
</li>
<li>
<p>The new client samples a 16bit random string and prompts the user to enter both the rendez-vous code and the random string into the existing client.</p>
</li>
<li>
<p>The new client uses the random string and the rendez-vous code to perform the first part of an SPAKE2 handshake, where the random string is used as the password and the rendez-vous code is used as the identity. It then establishes a websocket connection with the AS using the rendez-vous code and uploads the SPAKE2 outgoing message.</p>
</li>
<li>
<p>The existing client performs the responder's part of the SPAKE2 handshake and also establishes a websocket connection to the AS using the rendez-cous code. It then uploads the resulting outgoing message to the AS, picking up the new client's outgoing message in the process and completes the first phase of the SPAKE2 handshake.</p>
</li>
<li>
<p>The AS alerts the new client of the new upload.</p>
</li>
<li>
<p>The new client downloads the outgoing message, completes phase 2 of the SPAKE2 and uploads the key confirmation message.</p>
</li>
<li>
<p>The existing client downloads the confirmation message and posts its own confirmation message.</p>
</li>
<li>
<p>The new client downloads the existing client's confirmation message and uploads a CSR, which it AEAD-encrypts using the agreed-upon key.</p>
</li>
<li>
<p>The existing client downloads the CSR and submits it to the AS for signature, signing the request with its client credential.</p>
<ul>
<li>TODO: CSR submission has to happen via another endpoint.</li>
</ul>
</li>
<li>
<p>The AS validates the signature and the CSR and sends the signed credential to the new client via the websocket connection.</p>
<ul>
<li>TODO: The AS shouldn't send the signed CSR to the new client, but to the existing client, which then forwards it.</li>
</ul>
</li>
<li>
<p>The new client creates a KeyPackage for the EID, as well as for the user's all-clients group and uploads it, along with the corresponding intermediate certificate. All uploads are encrypted using the AEAD key.</p>
</li>
<li>
<p>The AS notifies the existing client of the upload.</p>
</li>
<li>
<p>The existing client downloads and validates it and uses the KeyPackage to add the new client to the EID. It sends the resulting commit to all other existing clients and the AS. The existing client also adds the new client to the user's all-clients group. It then uploads the Welcome for the EID and the all-clients group to the AS. Note that the Welcome for the all-clients group contains the EAR secrets for the group.</p>
</li>
<li>
<p>The new client downloads the Welcome and joins the group. It then requests anonymous tokens from the AS, authenticating the request with its client credential.</p>
</li>
<li>
<p>The AS repsonds with the tokens.</p>
</li>
<li>
<p>The new client contacts the QS to create its queues.</p>
</li>
<li>
<p>The existing client sends the client state to the new client via the all-client group. The new client state includes state-bundles for all groups that the user is in. These bundles include the group ID, member EAR secrets and PublicGroupStates of each group.</p>
</li>
<li>
<p>The new client injects itself into all of the user's group using the state-bundles. It sends attached the two commits for the EID state.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../spec/authentication_service/evolving_identities.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../spec/authentication_service/connection_establishment.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../spec/authentication_service/evolving_identities.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../spec/authentication_service/connection_establishment.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
