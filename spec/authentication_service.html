<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Authentication service - Docs</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../functional_requirements.html"><strong aria-hidden="true">1.</strong> Functional Requirements</a></li><li class="chapter-item expanded "><a href="../modularization.html"><strong aria-hidden="true">2.</strong> Modularization</a></li><li class="chapter-item expanded "><a href="../performance_goals.html"><strong aria-hidden="true">3.</strong> Performance Goals</a></li><li class="chapter-item expanded "><a href="../threat_model.html"><strong aria-hidden="true">4.</strong> Threat Model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../threat_model/qualitative.html"><strong aria-hidden="true">4.1.</strong> Qualitative Threat Models</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../threat_model/qualitative/authentication_service.html"><strong aria-hidden="true">4.1.1.</strong> Authentication Service</a></li><li class="chapter-item expanded "><a href="../threat_model/qualitative/federation.html"><strong aria-hidden="true">4.1.2.</strong> Federation</a></li></ol></li><li class="chapter-item expanded "><a href="../threat_model/stride.html"><strong aria-hidden="true">4.2.</strong> STRIDE</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../threat_model/stride/security_assumptions.html"><strong aria-hidden="true">4.2.1.</strong> Security Assumptions</a></li><li class="chapter-item expanded "><a href="../threat_model/stride/application_assets.html"><strong aria-hidden="true">4.2.2.</strong> Application Assets</a></li><li class="chapter-item expanded "><a href="../threat_model/stride/security_requirements.html"><strong aria-hidden="true">4.2.3.</strong> Security Requirements</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../threat_model/stride/security_requirements/operators.html"><strong aria-hidden="true">4.2.3.1.</strong> Operators</a></li><li class="chapter-item expanded "><a href="../threat_model/stride/security_requirements/public.html"><strong aria-hidden="true">4.2.3.2.</strong> Public</a></li><li class="chapter-item expanded "><a href="../threat_model/stride/security_requirements/users.html"><strong aria-hidden="true">4.2.3.3.</strong> Users</a></li><li class="chapter-item expanded "><a href="../threat_model/stride/security_requirements/clients.html"><strong aria-hidden="true">4.2.3.4.</strong> Clients</a></li><li class="chapter-item expanded "><a href="../threat_model/stride/security_requirements/federated_homeservers.html"><strong aria-hidden="true">4.2.3.5.</strong> Federated Homeservers</a></li><li class="chapter-item expanded "><a href="../threat_model/stride/security_requirements/federated_users.html"><strong aria-hidden="true">4.2.3.6.</strong> Federated Users</a></li><li class="chapter-item expanded "><a href="../threat_model/stride/security_requirements/federated_clients.html"><strong aria-hidden="true">4.2.3.7.</strong> Federated Clients</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../cryptographic_primitives.html"><strong aria-hidden="true">5.</strong> Cryptographic Primitives and Schemes</a></li><li class="chapter-item expanded "><a href="../spec.html"><strong aria-hidden="true">6.</strong> Specification (Draft)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../spec/authentication_service.html" class="active"><strong aria-hidden="true">6.1.</strong> Authentication service</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../spec/authentication_service/credentials.html"><strong aria-hidden="true">6.1.1.</strong> Credentials</a></li><li class="chapter-item expanded "><a href="../spec/authentication_service/connection_establishment.html"><strong aria-hidden="true">6.1.2.</strong> Discovery and connection establishment</a></li><li class="chapter-item expanded "><a href="../spec/authentication_service/security_guarantees.html"><strong aria-hidden="true">6.1.3.</strong> Security Guarantees</a></li></ol></li><li class="chapter-item expanded "><a href="../spec/delivery_service.html"><strong aria-hidden="true">6.2.</strong> Delivery service</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../spec/delivery_service/group_state_encryption.html"><strong aria-hidden="true">6.2.1.</strong> Group state encryption</a></li></ol></li><li class="chapter-item expanded "><a href="../spec/queuing_service.html"><strong aria-hidden="true">6.3.</strong> Queuing service</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../spec/queuing_service/queue_encryption.html"><strong aria-hidden="true">6.3.1.</strong> Queue encryption</a></li><li class="chapter-item expanded "><a href="../spec/queuing_service/keypackage_publication.html"><strong aria-hidden="true">6.3.2.</strong> KeyPackage publication</a></li></ol></li><li class="chapter-item expanded "><a href="../spec/federation.html"><strong aria-hidden="true">6.4.</strong> Federation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../spec/federation/use_cases.html"><strong aria-hidden="true">6.4.1.</strong> Use-cases and Threat Model</a></li><li class="chapter-item expanded "><a href="../spec/federation/federation_protocol.html"><strong aria-hidden="true">6.4.2.</strong> Federation protocol</a></li></ol></li><li class="chapter-item expanded "><a href="../spec/glossary.html"><strong aria-hidden="true">6.5.</strong> Glossary</a></li></ol></li><li class="chapter-item expanded "><a href="../authentication_systems.html"><strong aria-hidden="true">7.</strong> Authentication in messaging applications</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../authentication_systems/concepts.html"><strong aria-hidden="true">7.1.</strong> Concepts and security properties</a></li><li class="chapter-item expanded "><a href="../authentication_systems/comparison.html"><strong aria-hidden="true">7.2.</strong> Comparison of existing applications</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Docs</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="authentication-service-as"><a class="header" href="#authentication-service-as">Authentication Service (AS)</a></h1>
<p>In this chapter, we detail the different functionalitites of the authentication service. See the subchapter on <a href="authentication_service/credentials.html">credentials</a> for more details on the credential types referenced in this chapter.</p>
<p>For an overview over the security of the AS see <a href="./authentication_service/security_guarantees.html">here</a>.</p>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>The AS is configurable by use of the following configuration variables:</p>
<ul>
<li><strong>Anonymous token timeframe:</strong> The amount of time which each client has to wait until it can obtain new anonymous authentication tokens.</li>
<li><strong>Default token allowance:</strong> The default amount of anonymous authentication tokens issued to each user in the anonymous token timeframe.</li>
<li><strong>Maximal QS client record age:</strong> Maximal age of an inactive client entry.
<ul>
<li>Default: 90d</li>
</ul>
</li>
<li><strong>Maximal number of requested messages:</strong> Maximal number of messages that will be returned to a client requesting messages from a direct queue.</li>
</ul>
<h2 id="as-state"><a class="header" href="#as-state">AS state</a></h2>
<p>The AS generally keeps the following state</p>
<ul>
<li><strong>User entries:</strong> A database with one entry for each user account. Each entry is indexed by the user's <a href="glossary.html#user-id-uid">user id</a> and contains a number of sub-entries.
<ul>
<li><strong>OPAQUE user record:</strong> The OPAQUE protocol artifact that allows the user to authenticate itself via its password in queries to the AS.</li>
<li><strong>Encrypted user profile:</strong> The user's encrypted <a href="./glossary.html#user-profile">user profile</a>.</li>
<li><strong>Client entries:</strong> Sub entries for the users' clients. Indexed by the clients' <a href="glossary.html#client-id-cid">client id</a>.
<ul>
<li><strong>Client credential:</strong> The <a href="authentication_service/credentials.html#client-credentials">credential</a> of the client.</li>
<li><strong>Token issuance records:</strong> A record of how many tokens were issued to the client.</li>
<li><strong>Connection packages:</strong> Packages uploaded by the client and used in the <a href="authentication_service/connection_establishment.html">connection establishment process</a>.</li>
<li><strong>Direct queue:</strong> A queue similar to the fan-out queues on the QS. Used to enqueue encrypted <a href="./authentication_service/connection_establishment.html">connection establishment packages</a>.
<ul>
<li><strong>Activity time:</strong> Timestamp indicating the last time a client has fetched messages from the queue.</li>
<li><strong>Queue encryption key material:</strong> Key material to perform <a href="./queuing_service/queue_encryption.html">queue encryption</a>.
<ul>
<li><strong>Queue encryption key:</strong> HPKE public key of the queue owner</li>
<li><strong>Encryption ratchet key:</strong> Symmetric key used to derive queue encryption keys.</li>
</ul>
</li>
<li><strong>Current sequence number:</strong> The current message sequence number.</li>
<li><strong>Queued messages:</strong> A sequence of ciphertexts containing the messages in the queue. Each incoming message is <a href="./queuing_service/queue_encryption.html">encrypted</a> and is assigned the current sequence number, after which the current sequence number is incremented.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>Alias entries:</strong> Data not linked to user ids and instead indexed by <a href="./glossary.html#alias">Aliass</a>.
<ul>
<li><strong>Alias:</strong> The Alias associated with the direct queue.</li>
<li><strong>Direct queue:</strong> A queue similar to the fan-out queues on the QS. Used to enqueue encrypted <a href="./authentication_service/connection_establishment.html">connection establishment packages</a>.
<ul>
<li><strong>Activity time:</strong> Timestamp indicating the last time a client has fetched messages from the queue.</li>
<li><strong>Queue encryption key material:</strong> Key material to perform <a href="./queuing_service/queue_encryption.html">queue encryption</a>.
<ul>
<li><strong>Queue encryption key:</strong> HPKE public key of the queue owner</li>
<li><strong>Encryption ratchet key:</strong> Symmetric key used to derive queue encryption keys.</li>
</ul>
</li>
<li><strong>Current sequence number:</strong> The current message sequence number.</li>
<li><strong>Queued messages:</strong> A sequence of ciphertexts containing the messages in the queue. Each incoming message is <a href="./queuing_service/queue_encryption.html">encrypted</a> and is assigned the current sequence number, after which the current sequence number is incremented.</li>
</ul>
</li>
<li><strong>Connection package payloads:</strong> Packages uploaded by the client and used in the <a href="authentication_service/connection_establishment.html">connection establishment process</a>.</li>
</ul>
</li>
<li><strong>Ephemeral OPAQUE DB:</strong> An in-memory database that stores user-name or client-id indexed entries
<ul>
<li><strong>Client credential:</strong> Credential of the client that is being added to an existing user entry, or the initial client of a new user entry.</li>
<li><strong>Optional OPAQUE state:</strong> OPAQUE server state, only present in case of the OPAQUE online AKE flow, i.e. if a client performs 2FA, but not during an OPAQUE setup.</li>
</ul>
</li>
<li><strong>AS credential key material:</strong> Credentials that can be retrieved by clients, as well as the private key material used by the AS to sign client <a href="authentication_service/credentials.html#client-credential-signing-requests">CSRs</a>.</li>
<li><strong>AS OPAQUE key material:</strong> OPRF seed, server public key and server private key as required for the server to perform OPAQUE registration a login flows with clients.</li>
<li><strong>AS Privacy Pass key material:</strong> server public key and server private key as required for the server to process privacy pass token requests.</li>
</ul>
<h2 id="authentication"><a class="header" href="#authentication">Authentication</a></h2>
<p>There are four modes of authentication for endpoints on the AS.</p>
<ul>
<li><strong>None:</strong> For endpoints that are meant to be publicly accessible, e.g. user account registration</li>
<li><strong>Client Credential:</strong> A signature over a time stamp using the signature key in the calling client's ClientCredential. The request additionally contains the calling client's ClientCredential.</li>
<li><strong>Client Password:</strong> An OPAQUE login flow.</li>
<li><strong>Client 2FA:</strong> The same as <strong>Client</strong>, but additionally performing an <a href="https://datatracker.ietf.org/doc/draft-irtf-cfrg-opaque/">OPAQUE</a> login flow</li>
<li><strong>Alias auth key:</strong> A signature over a time stamp using the alias auth key. The request additionally contains the calling client's alias.</li>
</ul>
<p>If not explicitly mentioned, all endpoints additionally require the client to provide a valid privacy pass token as part of the request.</p>
<h2 id="initiate-2fa-operation"><a class="header" href="#initiate-2fa-operation">Initiate 2FA operation</a></h2>
<p>The client has to query this endpoint before it can query an endpoint that requires <strong>Client 2FA</strong> authentication. Note that this endpoint is not meant to be used with endpoints that require <strong>Client Password</strong> authentication such as the client addition endpoint. Similarly, this endpoint is not meant to be used to set up 2FA (see <a href="./authentication_service.html#initialize-user-registration">here</a> instead).</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Initiate2FaAuthenticationParams {
  client_id: ClientId,
  opaque_ke1: OpaqueKe1,
}
<span class="boring">}</span></code></pre></pre>
<p>The AS then performs the following steps:</p>
<ul>
<li>perform the <a href="https://www.ietf.org/archive/id/draft-irtf-cfrg-opaque-09.html#name-online-authenticated-key-exc">first (server side) step in the OPAQUE online AKE handshake</a></li>
<li>store the resulting OPAQUE <code>server_state</code> in its ephemeral DB</li>
<li>return the OPAQUE response to the client</li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Initiate2FaAuthenticationResponse {
  opaque_ke2: OpaqueKe2,
}
<span class="boring">}</span></code></pre></pre>
<h2 id="authentication-1"><a class="header" href="#authentication-1">Authentication</a></h2>
<ul>
<li>Client Credential</li>
</ul>
<h2 id="initialize-user-registration"><a class="header" href="#initialize-user-registration">Initialize user registration</a></h2>
<p>The user registration functionality requires the user to perform an <a href="https://www.ietf.org/archive/id/draft-irtf-cfrg-opaque-09.html#name-offline-registration">OPAQUE registration flow</a> with the homeserver. Note, that the user's chosen user id is part of the <code>client_csr</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct InitUserRegistrationParams {
  client_csr: ClientCsr,
  opaque_registration_request: OpaqueRegistrationRequest,
}
<span class="boring">}</span></code></pre></pre>
<p>The AS then performs the following steps:</p>
<ul>
<li>check if a user entry with the name given in the <code>client_csr</code> already exists</li>
<li>validate the <a href="./authentication_service/credentials.html#client-credential-signing-requests"><code>client_csr</code></a></li>
<li>perform the <a href="https://www.ietf.org/archive/id/draft-irtf-cfrg-opaque-09.html#name-createregistrationrequest">first (server side) step in the OPAQUE registration handshake</a></li>
<li>sign the CSR</li>
<li>store the freshly signed ClientCredential in the ephemeral DB</li>
<li>return the ClientCredential to the client along with the OPAQUE response.</li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct InitUserRegistrationResponse {
  client_credential: ClientCredential,
  opaque_registration_response: OpaqueRegistrationResponse,
}
<span class="boring">}</span></code></pre></pre>
<p>After receiving the response, the client must call the <a href="./authentication_service.html#finish-user-registration">finish user registration endpoint</a>.</p>
<h3 id="authentication-2"><a class="header" href="#authentication-2">Authentication</a></h3>
<ul>
<li>None</li>
</ul>
<h2 id="finish-user-registration"><a class="header" href="#finish-user-registration">Finish user registration</a></h2>
<p>This endpoint allows the user to finish its registration.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct FinishUserRegistrationParams {
  user_id: UserId,
  queue_encryption_key: HpkePublicKey,
  initial_queue_ratchet_key: RatchetKey,
  connection_packages: Vec&lt;ConnectionPackage&gt;,
  opaque_registration_record: OpaqueRegistrationRecord,
}
<span class="boring">}</span></code></pre></pre>
<p>The AS performs the following actions:</p>
<ul>
<li>look up the initial client's ClientCredential in the ephemeral DB based on the <code>user_id</code></li>
<li>authenticate the request using the signature key in the ClientCredential</li>
<li>check (again) if the user id already exists</li>
<li>create the user entry with the information given in the request</li>
<li>create the initial client entry</li>
<li>delete the entry in the ephemeral OPAQUE DB</li>
</ul>
<h3 id="authentication-3"><a class="header" href="#authentication-3">Authentication</a></h3>
<ul>
<li>Client 2FA (the AS has to successfully complete the OPAQUE handshake and the client needs to provide Client Credential authentication using the signature key of the initial client)</li>
</ul>
<h2 id="update-user-profile"><a class="header" href="#update-user-profile">Update user profile</a></h2>
<p>Allows users to update their <a href="./glossary.html#user-profile">user profile</a>. The profile is stored on the AS encrypted under the user's <a href="./glossary.html#user-profile-encryption-key">user profile encryption key</a>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct UpdateUserProfileParams {
  user_id: UserId,
  new_user_profile: Vec&lt;u8&gt;,
}
<span class="boring">}</span></code></pre></pre>
<p>The AS overwrites the existing user profile ciphertext with the new one.</p>
<h3 id="authentication-4"><a class="header" href="#authentication-4">Authentication</a></h3>
<ul>
<li>Client credential</li>
</ul>
<h2 id="fetch-user-profile"><a class="header" href="#fetch-user-profile">Fetch user profile</a></h2>
<p>Fetch the user profile of the user with the given user id.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct UserProfileParams {
  user_id: UserId,
}
<span class="boring">}</span></code></pre></pre>
<p>The AS responds with the encrypted user profile of the user with the given id.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct UserProfileResponse {
  user_profile: Vec&lt;u8&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="authentication-5"><a class="header" href="#authentication-5">Authentication</a></h3>
<ul>
<li>None</li>
</ul>
<h2 id="upload-user-id-connection-packages"><a class="header" href="#upload-user-id-connection-packages">Upload user id connection packages</a></h2>
<p>Upload the given encrypted <a href="authentication_service/connection_establishment.html#connection-group-creation">connection packages</a> to the user entry with the given user id.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct UploadUserIdPackages {
  user_id: UserId,
  connection_package_ctxt: Vec&lt;Vec&lt;u8&gt;&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="authentication-6"><a class="header" href="#authentication-6">Authentication</a></h3>
<ul>
<li>Client credential</li>
</ul>
<h2 id="get-user-id-connection-package"><a class="header" href="#get-user-id-connection-package">Get user id connection package</a></h2>
<p>Given a user id, get a <a href="authentication_service/connection_establishment.html#connection-group-creation">connection package</a> for the user's client.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct UserClientsParams {
  user_id: UserId,
}
<span class="boring">}</span></code></pre></pre>
<p>The AS returns the following information.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct UserClientsResponse {
  connection_package: ConnectionPackage,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="authentication-7"><a class="header" href="#authentication-7">Authentication</a></h3>
<ul>
<li>None</li>
</ul>
<h2 id="user-account-deletion"><a class="header" href="#user-account-deletion">User account deletion</a></h2>
<p>Delete the user account with the given user id.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct DeleteUserParams {
  user_id: UserId,
  opaque_ke3: OpaqueKe3,
}
<span class="boring">}</span></code></pre></pre>
<p>The AS performs the following actions:</p>
<ul>
<li>look up the OPAQUE <code>server_state</code> in the ephemeral DB based on the <code>client_id</code></li>
<li>authenticate the request using the signature key in the ClientCredential</li>
<li>perform the <code>ServerFinish</code> step of the OPAQUE online AKE flow</li>
<li>delete the user entry</li>
<li>delete the entry in the ephemeral OPAQUE DB</li>
</ul>
<h3 id="authentication-8"><a class="header" href="#authentication-8">Authentication</a></h3>
<ul>
<li>Client 2FA</li>
</ul>
<h2 id="dequeue-messages"><a class="header" href="#dequeue-messages">Dequeue messages</a></h2>
<p>Dequeue messages from a client's direct queue, starting with the message with the given sequence number.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct DequeueMessagesParams {
  client_id: ClientId,
  sequence_number_start: u64,
  max_message_number: u64,
}
<span class="boring">}</span></code></pre></pre>
<p>The AS deletes messages older than the given sequence number and returns messages starting with the given sequence number. The maximum number of messages returned this way is the smallest of the following values.</p>
<ul>
<li>The number of messages remaining in the queue</li>
<li>The value of the <code>max_message_number</code> field in the request</li>
<li>The AS configured maximum number of returned messages</li>
</ul>
<h3 id="authentication-9"><a class="header" href="#authentication-9">Authentication</a></h3>
<ul>
<li>Client</li>
</ul>
<h2 id="enqueue-message"><a class="header" href="#enqueue-message">Enqueue message</a></h2>
<p>Enqueue a message into a client's direct queue.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct EnqueueMessageParams {
  client_id: ClientId,
  connection_establishment_ctxt: Vec&lt;u8&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="authentication-10"><a class="header" href="#authentication-10">Authentication</a></h3>
<ul>
<li>None</li>
</ul>
<h2 id="get-as-credentials"><a class="header" href="#get-as-credentials">Get AS credentials</a></h2>
<p>Get the currently valid <a href="authentication_service/credentials.html#as-credentials">AS credentials</a> and <a href="authentication_service/credentials.html#as-intermediate-credentials">AS intermediate credentials</a>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct AsCredentialsResponse {
  as_credentials: Vec&lt;AsCredentials&gt;,
  as_intermediate_credentials: Vec&lt;AsIntermediateCredential&gt;,
  revoked_certs: Vec&lt;Fingerprint&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="authentication-11"><a class="header" href="#authentication-11">Authentication</a></h3>
<ul>
<li>None</li>
</ul>
<h2 id="register-alias"><a class="header" href="#register-alias">Register alias</a></h2>
<p>Register the given alias with the AS. After registration, the calling client can upload connection packages and dequeue messages from the queue associated with the alias.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct RegisterAlias {
  alias: Alias
  alias_auth_key: AliasAuthkey,
}
<span class="boring">}</span></code></pre></pre>
<p>The AS performs the following actions:</p>
<ul>
<li>Check that the alias is not already registered</li>
<li>Create a alias entry with the given alias and auth key</li>
</ul>
<h3 id="authentication-12"><a class="header" href="#authentication-12">Authentication</a></h3>
<ul>
<li>None</li>
</ul>
<h2 id="delete-alias"><a class="header" href="#delete-alias">Delete alias</a></h2>
<p>Delete the alias entry with the given alias, as well as the associated queue and connection packages.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct DeleteAlias {
  alias: Alias,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="authentication-13"><a class="header" href="#authentication-13">Authentication</a></h3>
<ul>
<li>Alias auth key</li>
</ul>
<h2 id="dequeue-alias-messages"><a class="header" href="#dequeue-alias-messages">Dequeue alias messages</a></h2>
<p>Dequeue messages from a alias direct queue, starting with the message with the given sequence number.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct DequeueAliasMessagesParams {
  alias: Alias,
  sequence_number_start: u64,
  max_message_number: u64,
}
<span class="boring">}</span></code></pre></pre>
<p>The AS deletes messages older than the given sequence number and returns messages starting with the given sequence number. The maximum number of messages returned this way is the smallest of the following values.</p>
<ul>
<li>The number of messages remaining in the queue</li>
<li>The value of the <code>max_message_number</code> field in the request</li>
<li>The AS configured maximum number of returned messages</li>
</ul>
<h3 id="authentication-14"><a class="header" href="#authentication-14">Authentication</a></h3>
<ul>
<li>Alias auth key</li>
</ul>
<h2 id="enqueue-alias-messages"><a class="header" href="#enqueue-alias-messages">Enqueue alias messages</a></h2>
<p>Enqueue a message into a client's direct queue.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct EnqueueAliasMessageParams {
  alias: Alias,
  connection_establishment_ctxt: Vec&lt;u8&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="authentication-15"><a class="header" href="#authentication-15">Authentication</a></h3>
<ul>
<li>None</li>
</ul>
<h2 id="upload-alias-connection-package-payloads"><a class="header" href="#upload-alias-connection-package-payloads">Upload alias connection package payloads</a></h2>
<p>Upload the given <a href="authentication_service/connection_establishment.html#connection-group-creation">connection package payloads</a> to the alias entry with the given alias. Note that in contrast to the similar functionality for user ids, this endpoint only takes the payloads of the connection packages as input.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct UploadAliasPackages {
  alias: Alias,
  connection_package_ctxt: Vec&lt;ConnectionPackagePayload&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="authentication-16"><a class="header" href="#authentication-16">Authentication</a></h3>
<ul>
<li>Alias auth key</li>
</ul>
<h2 id="get-alias-connection-package"><a class="header" href="#get-alias-connection-package">Get alias connection package</a></h2>
<p>Given a alias, get a <a href="authentication_service/connection_establishment.html#connection-group-creation">connection package</a> for the user's client.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct AliasClientsParams {
  alias: Alias,
}
<span class="boring">}</span></code></pre></pre>
<p>The AS returns the following information.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct AliasClientsResponse {
  connection_package: ConnectionPackagePayload,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="authentication-17"><a class="header" href="#authentication-17">Authentication</a></h3>
<ul>
<li>None</li>
</ul>
<h2 id="token-issuance"><a class="header" href="#token-issuance">Token Issuance</a></h2>
<p>This endpoints allows both local clients and clients of federated homeservers to retrieve Privacy Pass tokens which they can then redeem to interact with the local DS.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct RequestToken {
  client_id: ClientId,
  token_request: TokenRequest,
}
<span class="boring">}</span></code></pre></pre>
<p><code>TokenRequest</code> represents a Privacy Pass token request. The server processes the request, checks if the client sufficient allowance left, reduces the allowance and responds with the tokens.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct TokenResponse {
  tokens: Vec&lt;Token&gt;
}
<span class="boring">}</span></code></pre></pre>
<h3 id="rate-limiting"><a class="header" href="#rate-limiting">Rate-limiting</a></h3>
<p>Token issuance is the main way of rate-limiting queries to the endpoints of the DS of a homeserver, which means that the AS should rate-limit token issuance based on a per-client basis, essentially giving each client a certain allowance of tokens.</p>
<p>If the calling client is a federated client, rate-limiting should also occur on a per-homeserver (or per homeserver domain) basis to protect agains malicious or negligent homeservers that allow an attacker to register a large number of clients.</p>
<h3 id="authentication-18"><a class="header" href="#authentication-18">Authentication</a></h3>
<p>For this endpoint, the AS also accepts authentication by federated clients. If the <code>client_id</code> in the client credential indicates that the client belongs to a federated homeserver, the AS looks up the authentication key material of that client's AS using the <a href="./authentication_service.html#get-as-credentials">corresponding endpoint</a>, or looks the key material up in its local cache. The AS then uses that key material to verify the query.</p>
<ul>
<li>Client Credential</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../spec.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../spec/authentication_service/credentials.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../spec.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../spec/authentication_service/credentials.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
